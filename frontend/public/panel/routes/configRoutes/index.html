<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurar Rotas</title>
    <link rel="stylesheet" href="configRoutes.css" />
    <link rel="icon" href="../images/logo.png" />
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="profile">
          <h2>Nome da Pessoa</h2>
        </div>
        <ul class="menu">
          <li><a href="/panel">Página Inicial</a></li>
          <li><a href="/panel/profile">Minha Conta</a></li>
          <li><a href="/panel/enterprise">Empresa</a></li>
          <li><a href="/panel/routes">Rotas</a></li>
          <li><a href="/panel/config">Configurações</a></li>
          <li><a href="/panel/notification">Notificações</a></li>
          <li><a href="#" data-logout>Sair</a></li>
        </ul>
      </div>

      <div class="main-content">
        <div class="containerCentro">
          <div class="containerEsquerdo">
            <div class="TituloEmpresas">
              <h1>SELECIONE UMA EMPRESA</h1>
              <div id="firm-selector-container">
                <p>Carregando empresas...</p>
              </div>
            </div>

            <div class="TituloRotas">
              <h1>SELECIONE UMA ROTA</h1>
              <div id="listed-routes-container">
                <p>Selecione uma empresa para ver as rotas.</p>
              </div>
            </div>
          </div>

          <div class="containerDireito">
            <div class="TituloEntregas">
              <h1>MARQUE AS ENTREGAS</h1>
              <div id="listed-deliveries-container">
                <p>Selecione uma empresa e uma rota para ver as entregas.</p>
              </div>
            </div>
            <div class="BotoesRotas">
              <button class="salvar" id="save-associations-button">
                Salvar Associações
              </button>
              <button
                class="voltar"
                onclick="window.location.href='/panel/routes'"
              >
                Voltar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let selectedFirmId = null;
      let selectedRouteId = null;
      let allDeliveries = [];

      async function fetchAndRenderFirms() {
        const container = document.getElementById("firm-selector-container");
        try {
          const response = await fetch("/api/firms", {
            credentials: "include",
          });
          if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
          const firms = await response.json();

          if (firms.length === 0) {
            container.innerHTML = "<p>Nenhuma empresa cadastrada.</p>";
            return;
          }

          const select = document.createElement("select");
          select.id = "firm-select";

          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Selecione uma empresa...";
          select.appendChild(defaultOption);

          firms.forEach((firm) => {
            const option = document.createElement("option");
            option.value = firm.id_firm;
            option.textContent = firm.name;
            select.appendChild(option);
          });

          select.addEventListener("change", (event) => {
            selectedFirmId = event.target.value;
            selectedRouteId = null;
            allDeliveries = [];

            if (selectedFirmId) {
              fetchAndRenderRoutes(selectedFirmId);
              fetchAndRenderDeliveries(selectedFirmId);
            } else {
              document.getElementById("listed-routes-container").innerHTML =
                "<p>Selecione uma empresa para ver as rotas.</p>";
              document.getElementById("listed-deliveries-container").innerHTML =
                "<p>Selecione uma empresa para ver as entregas.</p>";
            }
          });

          container.innerHTML = "";
          container.appendChild(select);
        } catch (error) {
          console.error("Erro ao buscar empresas:", error);
          container.innerHTML = "<p>Erro ao carregar empresas.</p>";
        }
      }

      async function fetchAndRenderRoutes(firmId) {
        const container = document.getElementById("listed-routes-container");
        container.innerHTML = "<p>Buscando rotas...</p>";
        document.getElementById("listed-deliveries-container").innerHTML =
          "<p>Selecione uma rota para ver as entregas.</p>";

        try {
          const response = await fetch(`/api/routes/firm/${firmId}`, {
            credentials: "include",
          });
          if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
          const routes = await response.json();
          container.innerHTML = "";

          if (routes.length === 0) {
            container.innerHTML =
              "<p>Nenhuma rota cadastrada para esta empresa.</p>";
            return;
          }

          routes.forEach((route) => {
            const button = document.createElement("button");
            button.className = "route-button";
            button.dataset.id = route.id_route;

            let content = `<strong>${route.name}</strong>`;
            if (route.description) {
              content += ` - ${route.description}`;
            }
            content += `<br><small>Última atualização: ${new Date(
              route.updatedAt
            ).toLocaleDateString("pt-BR")}</small>`;
            button.innerHTML = content;

            button.addEventListener("click", () => {
              document
                .querySelectorAll(".route-button.selected")
                .forEach((btn) => btn.classList.remove("selected"));
              button.classList.add("selected");
              selectedRouteId = route.id_route;
              updateDeliveryCheckboxes();
            });
            container.appendChild(button);
          });
        } catch (error) {
          console.error("Erro ao buscar rotas:", error);
          container.innerHTML = "<p>Erro ao carregar rotas.</p>";
        }
      }

      async function fetchAndRenderDeliveries(firmId) {
        const container = document.getElementById(
          "listed-deliveries-container"
        );
        container.innerHTML = "<p>Buscando entregas...</p>";

        try {
          const response = await fetch(`/api/deliveries/${firmId}`, {
            credentials: "include",
          });
          if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
          allDeliveries = await response.json();

          if (allDeliveries.length === 0) {
            container.innerHTML =
              "<p>Nenhuma entrega cadastrada para esta empresa.</p>";
            return;
          }

          container.innerHTML =
            "<p>Selecione uma rota para associar as entregas.</p>";
        } catch (error) {
          console.error("Erro ao buscar entregas:", error);
          container.innerHTML = "<p>Erro ao carregar entregas.</p>";
          allDeliveries = [];
        }
      }

      function updateDeliveryCheckboxes() {
        const container = document.getElementById(
          "listed-deliveries-container"
        );
        container.innerHTML = "";

        if (!selectedRouteId) {
          container.innerHTML =
            "<p>Selecione uma rota para associar entregas.</p>";
          return;
        }

        const availableDeliveries = allDeliveries.filter(
          (delivery) =>
            delivery.fk_id_route === null ||
            delivery.fk_id_route === selectedRouteId
        );

        if (availableDeliveries.length === 0) {
          container.innerHTML =
            "<p>Nenhuma entrega disponível para esta rota.</p>";
          return;
        }

        availableDeliveries.forEach((delivery) => {
          const deliveryId = `delivery-${delivery.id_delivery}`;
          const item = document.createElement("div");
          item.className = "delivery-item";

          const isChecked = delivery.fk_id_route === selectedRouteId;

          let deliveryDate = "Não informada";
          if (delivery.date) {
            const date = new Date(delivery.date);
            deliveryDate = date.toLocaleDateString("pt-BR", {
              timeZone: "UTC",
            });
          }

          item.innerHTML = `
            <input type="checkbox" id="${deliveryId}" data-id="${
            delivery.id_delivery
          }" ${isChecked ? "checked" : ""}>
            <label for="${deliveryId}">
              <strong>Endereço:</strong> ${delivery.address}
              <br>
              <small>Status: <strong>${
                delivery.status
              }</strong> | Data de entrega: ${deliveryDate}</small>
            </label>
          `;
          container.appendChild(item);
        });
      }

      async function saveAssociations() {
        if (!selectedRouteId) {
          alert("Por favor, selecione uma rota antes de salvar.");
          return;
        }

        const checkboxes = document.querySelectorAll(
          '#listed-deliveries-container input[type="checkbox"]'
        );
        const associatedDeliveryIds = Array.from(checkboxes)
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => checkbox.dataset.id);

        const button = document.getElementById("save-associations-button");
        button.textContent = "Salvando...";
        button.disabled = true;

        try {
          const response = await fetch(`/api/deliveries/${selectedRouteId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ deliveryIds: associatedDeliveryIds }),
            credentials: "include",
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              message: "O servidor não retornou um erro JSON válido.",
            }));
            throw new Error(
              `O servidor respondeu com o erro ${response.status}: ${errorData.message}`
            );
          }

          alert("Associações salvas com sucesso!");

          if (selectedFirmId) {
            await fetchAndRenderDeliveries(selectedFirmId);
          }
          updateDeliveryCheckboxes();
        } catch (error) {
          console.error("Erro ao salvar associações:", error);
          alert(`Falha ao salvar as associações: ${error.message}`);
        } finally {
          button.textContent = "Salvar Associações";
          button.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchAndRenderFirms();
      });

      document
        .getElementById("save-associations-button")
        .addEventListener("click", saveAssociations);
    </script>
  </body>
</html>
