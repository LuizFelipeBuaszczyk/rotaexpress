<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
    <link rel="stylesheet" href="./routes.css" />
    <script type="module" src="/panel/panel.js" defer></script>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="profile">
          <h2>Nome da Pessoa</h2>
        </div>
        <ul class="menu">
          <li><a href="/panel">Página Inicial</a></li>
          <li><a href="/panel/profile">Minha Conta</a></li>
          <li><a href="/panel/enterprise">Organizações</a></li>
          <li><a href="/panel/routes">Rotas</a></li>
          <li><a href="/panel/config">Configurações</a></li>
          <li><a href="/panel/notification">Notificações</a></li>
          <li><a href="#" data-logout>Sair</a></li>
        </ul>
      </div>

      <div class="main-content">
        <div class="containerCentro">
          <div class="containerEsquerdo">
            <div class="SelecionarEmpresa">
              <h1>SELECIONE UMA EMPRESA</h1>
              <div id="firm-selector-container">
                <p>Carregando empresas...</p>
              </div>
            </div>

            <div class="SelecionarRotas">
              <h1>ROTAS</h1>
              <br />
              <div id="route-buttons-container">
                <p>Selecione uma empresa para ver as rotas.</p>
              </div>
            </div>

            <div class="BotaoAcoes">
              <button
                id="config-route-btn"
                onclick="window.location.href='./configRoutes/index.html'"
              >
                Configurar Rotas
              </button>
              <div id="share-button-container" style="display: none">
                <button id="share-route-btn">Compartilhar Rota</button>
              </div>
            </div>
          </div>

          <div class="containerDireito" id="map">
            <p>Clique em uma rota para ver o mapa.</p>
          </div>
        </div>

        <div id="logout-modal" class="modal">
          <div class="content-modal">
            <p>Tem certeza que deseja sair?</p>
            <button id="cancel-logout-button">Cancelar</button>
            <button id="confirm-logout-button">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const Maps_API_KEY = "";

      let mapLoaded = false;
      let mapInstance;
      let currentRoutePath = null;
      let currentMarkers = [];
      let selectedFirmId = null;

      function initMap(routeData) {
        if (!routeData || !routeData.polyline || !routeData.origin) {
          document.getElementById("map").innerHTML =
            "<p>Ocorreu um erro ao gerar a rota. Faltam informações essenciais.</p>";
          return;
        }
        const decodedPath = google.maps.geometry.encoding.decodePath(
          routeData.polyline
        );
        if (decodedPath.length === 0) {
          document.getElementById("map").innerHTML =
            "<p>Não foi possível decodificar a rota. Verifique os endereços.</p>";
          return;
        }

        if (!mapInstance) {
          document.getElementById("map").innerHTML = "";
          mapInstance = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: decodedPath[0],
            streetViewControl: false,
          });
          mapLoaded = true;
        }
        if (currentRoutePath) currentRoutePath.setMap(null);
        currentMarkers.forEach((marker) => marker.setMap(null));
        currentMarkers = [];

        if (window.infoWindow) window.infoWindow.close();
        else window.infoWindow = new google.maps.InfoWindow();

        const routePath = new google.maps.Polyline({
          path: decodedPath,
          strokeColor: "#4285F4",
          strokeWeight: 4,
        });
        routePath.setMap(mapInstance);
        currentRoutePath = routePath;

        const originMarker = new google.maps.Marker({
          position: decodedPath[0],
          map: mapInstance,
          title: routeData.origin,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "white",
          },
        });
        currentMarkers.push(originMarker);

        originMarker.addListener("click", () => {
          const contentString = `<div><h4>Origem</h4><p>${routeData.origin}</p></div>`;
          window.infoWindow.setContent(contentString);
          window.infoWindow.open(mapInstance, originMarker);
        });

        const geocoder = new google.maps.Geocoder();
        const deliveries = routeData.deliveries || [];

        let waypointOrderArray = null;
        if (routeData.waypoint_order) {
          if (typeof routeData.waypoint_order === "string") {
            try {
              waypointOrderArray = JSON.parse(routeData.waypoint_order);
            } catch (e) {
              waypointOrderArray = [];
            }
          } else if (Array.isArray(routeData.waypoint_order)) {
            waypointOrderArray = routeData.waypoint_order;
          }
        }
        const orderedDeliveries = waypointOrderArray
          ? waypointOrderArray.map((i) => deliveries[i]).filter(Boolean)
          : deliveries;

        if (orderedDeliveries.length > 0) {
          orderedDeliveries.forEach((delivery, index) => {
            geocoder.geocode(
              { address: delivery.address },
              (results, status) => {
                if (status === "OK") {
                  const markerPosition = results[0].geometry.location;
                  const marker = new google.maps.Marker({
                    position: markerPosition,
                    map: mapInstance,
                    label: `${index + 1}`,
                    title: delivery.address,
                  });
                  currentMarkers.push(marker);
                  marker.addListener("click", () => {
                    const contentString = `<div><h4>Entrega ${
                      index + 1
                    }</h4><p>${delivery.address}</p></div>`;
                    window.infoWindow.setContent(contentString);
                    window.infoWindow.open(mapInstance, marker);
                  });
                }
              }
            );
          });
        }
        const bounds = new google.maps.LatLngBounds();
        decodedPath.forEach((point) => bounds.extend(point));
        mapInstance.fitBounds(bounds);

        const shareBtnContainer = document.getElementById(
          "share-button-container"
        );
        shareBtnContainer.style.display = "none";

        if (orderedDeliveries.length > 0) {
          const shareBtn = document.getElementById("share-route-btn");
          const baseUrl = "https://www.google.com/maps/dir/";
          const allStops = [
            routeData.origin,
            ...orderedDeliveries.map((d) => d.address),
            routeData.origin,
          ];
          const encodedStops = allStops
            .map((stop) => encodeURIComponent(stop))
            .join("/");
          const finalUrl = `${baseUrl}${encodedStops}`;

          shareBtn.onclick = () => {
            if (navigator.share) {
              navigator
                .share({
                  title: `RotaExpress - Rota ${
                    routeData.name || "Personalizada"
                  }`,
                  text: "Confira a rota de entrega otimizada.",
                  url: finalUrl,
                })
                .catch(console.error);
            } else {
              navigator.clipboard.writeText(finalUrl).then(
                () => {
                  alert("Link da rota copiado para a área de transferência!");
                },
                () => {
                  prompt("Copie o link manualmente:", finalUrl);
                }
              );
            }
          };
          shareBtnContainer.style.display = "block";
        }
      }

      function loadGoogleMapsScript(callback) {
        if (window.google && window.google.maps) {
          if (callback) callback();
          return;
        }
        window.googleMapsLoaded = callback;
        const script = document.createElement("script");
        script.loading = "async";
        script.src = `https://maps.googleapis.com/maps/api/js?key=${Maps_API_KEY}&libraries=geometry,places&callback=googleMapsLoaded`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }

      async function callBackendToGenerateRoute(payload) {
        const generateResponse = await fetch(`/api/routes/generate-route`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload),
        });
        if (!generateResponse.ok) {
          const errorData = await generateResponse
            .json()
            .catch(() => ({ message: "Erro desconhecido no servidor." }));
          throw new Error(
            `Erro: ${generateResponse.status}. ${errorData.message}`
          );
        }
        return await generateResponse.json();
      }

      async function fetchAndRenderFirms() {
        const container = document.getElementById("firm-selector-container");
        try {
          const response = await fetch("/api/firms", {
            credentials: "include",
          });
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const firms = await response.json();
          if (firms.length === 0) {
            container.innerHTML = "<p>Nenhuma empresa cadastrada.</p>";
            return;
          }
          const select = document.createElement("select");
          select.id = "firm-select";
          select.innerHTML = `<option value="">Selecione uma empresa...</option>`;
          firms.forEach((firm) => {
            select.innerHTML += `<option value="${firm.id_firm}">${firm.name}</option>`;
          });
          select.addEventListener("change", (event) => {
            selectedFirmId = event.target.value;
            document.getElementById("map").innerHTML =
              "<p>Clique em uma rota para ver o mapa.</p>";
            document.getElementById("share-button-container").style.display =
              "none";
            mapInstance = null;
            mapLoaded = false;
            if (currentRoutePath) currentRoutePath.setMap(null);
            currentMarkers.forEach((marker) => marker.setMap(null));
            currentMarkers = [];

            if (selectedFirmId) {
              fetchAndRenderRouteButtons(selectedFirmId);
            } else {
              document.getElementById("route-buttons-container").innerHTML =
                "<p>Selecione uma empresa para ver as rotas.</p>";
            }
          });
          container.innerHTML = "";
          container.appendChild(select);
        } catch (error) {
          container.innerHTML = "<p>Erro ao carregar empresas.</p>";
        }
      }

      async function fetchAndRenderRouteButtons(firmId) {
        const buttonsContainer = document.getElementById(
          "route-buttons-container"
        );
        buttonsContainer.innerHTML = "<p>Carregando rotas...</p>";
        try {
          const response = await fetch(`/api/routes/firm/${firmId}`, {
            method: "GET",
            credentials: "include",
          });
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const routesList = await response.json();
          buttonsContainer.innerHTML = "";
          if (routesList.length === 0) {
            buttonsContainer.innerHTML =
              "<p>Nenhuma rota disponível para esta empresa.</p>";
            return;
          }
          routesList.forEach((route) => {
            const button = document.createElement("button");
            button.type = "button";
            button.classList.add("route-button");
            button.dataset.routeId = route.id_route;
            let buttonTitle = `<strong>Rota - ${route.name}</strong>`;
            if (route.description) {
              buttonTitle += ` - <small>${route.description}</small>`;
            }
            button.dataset.originalHtml = buttonTitle;
            button.innerHTML = button.dataset.originalHtml;

            button.addEventListener("click", (event) => {
              const clickedButton = event.currentTarget;
              const allButtons =
                buttonsContainer.querySelectorAll(".route-button");

              const resetButtons = () => {
                allButtons.forEach((btn) => {
                  btn.disabled = false;
                  btn.innerHTML = btn.dataset.originalHtml;
                });
              };

              allButtons.forEach((btn) => (btn.disabled = true));
              clickedButton.textContent = "Carregando...";
              document.getElementById("share-button-container").style.display =
                "none";

              loadGoogleMapsScript(async () => {
                try {
                  const detailsResponse = await fetch(
                    `/api/routes/${route.id_route}`,
                    { method: "GET", credentials: "include" }
                  );
                  if (!detailsResponse.ok)
                    throw new Error(
                      `HTTP error! status: ${detailsResponse.status}`
                    );
                  const routeDetails = await detailsResponse.json();

                  const firmResponse = await fetch(
                    `/api/firms/route/${route.id_route}`,
                    { method: "GET", credentials: "include" }
                  );
                  if (!firmResponse.ok)
                    throw new Error(
                      "Não foi possível buscar os dados da empresa."
                    );
                  const firmDetails = await firmResponse.json();
                  routeDetails.origin = firmDetails.address;
                  routeDetails.name = route.name;

                  if (routeDetails.polyline) {
                    initMap(routeDetails);
                  } else {
                    if (
                      !routeDetails.deliveries ||
                      routeDetails.deliveries.length === 0
                    ) {
                      throw new Error("Rota sem entregas");
                    }
                    clickedButton.textContent = "Gerando Rota...";
                    const payload = {
                      id_route: route.id_route,
                      deliveryIds: routeDetails.deliveries.map(
                        (d) => d.id_delivery
                      ),
                      originAddress: firmDetails.address,
                      routeName: routeDetails.name,
                      id_delivery_guy: routeDetails.id_delivery_guy,
                    };
                    const newlyGeneratedRoute =
                      await callBackendToGenerateRoute(payload);
                    const finalRouteData = {
                      ...routeDetails,
                      ...newlyGeneratedRoute,
                    };
                    initMap(finalRouteData);
                  }
                } catch (error) {
                  if (error.message === "Rota sem entregas") {
                    document.getElementById(
                      "map"
                    ).innerHTML = `<p>Esta rota não possui entregas.</p>`;
                  } else {
                    document.getElementById(
                      "map"
                    ).innerHTML = `<p>Ocorreu um erro ao carregar a rota.</p><p><small>${error.message}</small></p>`;
                  }
                  mapInstance = null;
                  mapLoaded = false;
                } finally {
                  resetButtons();
                }
              });
            });
            buttonsContainer.appendChild(button);
          });
        } catch (error) {
          buttonsContainer.innerHTML = "<p>Erro ao carregar rotas.</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", fetchAndRenderFirms);
    </script>
  </body>
</html>
